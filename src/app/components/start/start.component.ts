import { Component, OnInit } from '@angular/core';
import { PenetrationTestService } from 'src/app/services/penetration-test.service';
import { PenetrationTest, PenetrationTestStatus } from 'src/app/models/penetration-test.model';
import { DebugService } from 'src/app/services/debug.service';
import { sleep } from 'src/app/helpers/utils.helper';

@Component({
  selector: 'app-start',
  templateUrl: './start.component.html',
  styleUrls: ['./start.component.scss']
})
export class StartComponent implements OnInit {

  isLoading: boolean = true;
  tests: PenetrationTest[] = [];
  pendingTest: PenetrationTest = null;

  constructor(
    private penTestService: PenetrationTestService,
    private debugService: DebugService
  ) { }

  ngOnInit(): void {
    this.tests = [...this.penTestService.tests];
    this.pendingTest = this.tests[0];
    this.debugService.log('tests:', this.tests);
    this.runTests();
  }

  private async runTests() {
    let index = 0;
    for (const test of this.tests) {
      const nextTest: PenetrationTest = this.tests[++index] ||Â null;
      await sleep(500); // reduce tests speed
      await this.runTest(test, nextTest);
    }
    this.isLoading = false;
    this.pendingTest = null;
  }

  private async runTest(test: PenetrationTest, nextTest?: PenetrationTest) {
    this.debugService.log('starting test:', test);
    test.startDate = new Date();
    test.status = PenetrationTestStatus.Pending;
    test.results = await test.run;
    test.endDate = new Date();
    test.status = test.results.success ? PenetrationTestStatus.Success : PenetrationTestStatus.Failed;
    this.pendingTest = nextTest;
    this.debugService.log('test ended:', {
      test: test,
      pendingTest: this.pendingTest
    });
  }

  reload(): void {
    window.open('./start', '_self');
  }

}
