import { Component, OnInit } from '@angular/core';
import { PenetrationTestService } from 'src/app/services/penetration-test.service';
import { PenetrationTest, PenetrationTestStatus } from 'src/app/models/penetration-test.model';
import { DebugService } from 'src/app/services/debug.service';
import { sleep } from 'src/app/helpers/promise.helper';

@Component({
  selector: 'app-scan',
  templateUrl: './scan.component.html',
  styleUrls: ['./scan.component.scss']
})
export class ScanComponent implements OnInit {

  tests: PenetrationTest[] = [];
  pendingTest: PenetrationTest = null;
  isComplete: boolean = false;
  isResultModalVisible: boolean = false;
  results: any = {};

  constructor(
    private penTestService: PenetrationTestService,
    private debugService: DebugService
  ) { }

  ngOnInit(): void {
    this.tests = [...this.penTestService.tests];
    this.pendingTest = this.tests[0];
    this.debugService.log('tests:', this.tests);
    this.runTests();
  }

  private async runTests() {
    let index = 0;
    for (const test of this.tests) {
      const nextTest: PenetrationTest = this.tests[++index] ||Â null;
      await sleep(500); // reduce tests speed
      await this.runTest(test, nextTest);
    }
    this.isComplete = true;
    this.pendingTest = null;
    this.results = {
      passedTests: this.tests.filter((test: PenetrationTest) => test.results.success).length,
      totalDuration: this.tests.reduce((a: PenetrationTest, b: PenetrationTest) => {
        return { duration: a.duration + b.duration } as any;
      }, { duration: 0 } as any).duration
    };
    this.isResultModalVisible = true;
  }

  private async runTest(test: PenetrationTest, nextTest?: PenetrationTest) {
    this.debugService.log('starting test:', test);
    test.startDate = new Date();
    test.status = PenetrationTestStatus.Pending;
    test.results = await test.run();
    test.endDate = new Date();
    test.duration = test.endDate.getTime() - test.startDate.getTime();
    test.status = test.results.success ? PenetrationTestStatus.Success : PenetrationTestStatus.Failed;
    this.pendingTest = nextTest;
    this.debugService.log('test ended:', {
      test: test,
      pendingTest: this.pendingTest
    });
  }

  rescan(): void {
    window.open('./scan', '_self');
  }

}
